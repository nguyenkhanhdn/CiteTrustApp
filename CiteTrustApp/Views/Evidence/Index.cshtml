@model IEnumerable<CiteTrustApp.Models.Evidence>
@{
    ViewBag.Title = "Tìm kiếm dẫn chứng";
    var categories = ViewBag.Categories as List<CiteTrustApp.Models.Category> ?? new List<CiteTrustApp.Models.Category>();
    var sources = ViewBag.Sources as List<CiteTrustApp.Models.Source> ?? new List<CiteTrustApp.Models.Source>();
    Layout = "~/Views/Shared/_LayoutNoHero.cshtml";

    var currentPage = ViewBag.Page as int? ?? 1;
    var pageSize = ViewBag.PageSize as int? ?? 12;
    var totalCount = ViewBag.TotalCount as int? ?? 0;

    var suggestionVm = ViewBag.SuggestionVm as CiteTrustApp.Models.SuggestionViewModel;
}
<section id="breadcrumbs" class="breadcrumbs">
    <div class="breadcrumb-hero">
        <div class="container">
            <div class="breadcrumb-hero">
                <h2>Ngân hàng dẫn chứng học thuật</h2>
            </div>
        </div>
    </div>

</section><!-- End Breadcrumbs -->
<div class="container my-4">
    <div class="card p-4 mb-4">
        <div class="row">
            <div class="col-md-8 mb-2">
                <input id="qInput" class="form-control" placeholder="Tìm kiếm dẫn chứng, tác giả..." />
            </div>
            <div class="col-md-4 mb-2">
                <select id="sourceSelect" class="form-control">
                    <option value="">Tất cả nguồn</option>
                    @foreach (var s in sources)
                    {
                        <option value="@s.Id">@s.Title</option>
                    }
                </select>
            </div>
        </div>

        <div class="mt-3">
            <div id="categoryButtons" class="d-flex flex-wrap">
                <button class="btn btn-sm btn-primary mr-2 mb-2 category-btn" data-category="">Tất cả</button>
                @foreach (var c in categories)
                {
                    <button class="btn btn-sm btn-outline-secondary mr-2 mb-2 category-btn" data-category="@c.Id">@c.Name</button>
                }
            </div>
        </div>
    </div>

    @* User interests + AI suggestions partial:
        - If controller provided ViewBag.SuggestionVm, render server-side.
        - Otherwise a container will be populated by AJAX calling Evidence/Suggest. *@
    @if (suggestionVm != null)
    {
        @Html.Partial("_UserInterests", suggestionVm)
    }
    else
    {
        <div id="userInterestsContainer"></div>
    }

    <div id="results" class="row">
        @foreach (var ev in Model)
        {
            @Html.Partial("_EvidenceCard", ev)
        }
    </div>

    <div id="noResults" class="alert alert-light" style="display:@(totalCount == 0 ? "block" : "none")">
        Không tìm thấy kết quả.
    </div>

    <div id="paginationContainer" class="mt-3">
        @Html.Partial("_Pagination")
    </div>
</div>
@section scripts {
    <script>

        function doClose() {
            var modal = $('#aiAnalysisModal');
            if (modal.length) {
                modal.modal('hide');
            }
        }
        (function () {
    var searchTimeout;
    var currentPage = @(currentPage);
    var pageSize = @(pageSize);

    function performSearch(page) {
        page = page || 1;
        var q = $('#qInput').val();
        var categoryId = $('.category-btn.active').data('category');
        var sourceId = $('#sourceSelect').val();

        $.get('@Url.Action("SearchAjax", "Evidence")', { q: q, categoryId: categoryId, sourceId: sourceId, page: page, pageSize: pageSize })
            .done(function (res) {
                $('#results').html(res.html);
                $('#paginationContainer').html(res.paginationHtml || '');
                if (!res.html || res.html.trim() === '') {
                    $('#noResults').show();
                } else {
                    $('#noResults').hide();
                }
                currentPage = page;
            });
    }

    function loadSuggestions() {
        // If server already rendered suggestions, container may be empty; still attempt to refresh via AJAX.
        var categoryId = $('.category-btn.active').data('category') || '';
        $.get('@Url.Action("Suggest", "Evidence")', { max: 5, categoryId: categoryId })
            .done(function (html) {
                // if partial returned HTML, inject into container (or replace existing partial)
                $('#userInterestsContainer').html(html);
            })
            .fail(function () {
                // silently ignore failures
            });
    }

    // debounce input
    $('#qInput').on('input', function () {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function () { performSearch(1); }, 350);
    });

    // source change
    $('#sourceSelect').on('change', function () { performSearch(1); });

    // category buttons
    $('#categoryButtons').on('click', '.category-btn', function () {
        $('.category-btn').removeClass('active btn-primary').addClass('btn-outline-secondary');
        $(this).removeClass('btn-outline-secondary').addClass('active btn-primary');
        performSearch(1);
        loadSuggestions(); // refresh suggestions when user selects a different category
    });

    // pagination click (delegated)
    $('body').on('click', '.page-link-go', function (e) {
        e.preventDefault();
        var page = parseInt($(this).data('page') || 1, 10);
        if (!page || page < 1) page = 1;
        performSearch(page);
        // scroll to top of results
        $('html, body').animate({ scrollTop: $('#results').offset().top - 80 }, 300);
    });

            // copy handler (delegated)
            $('body').on('click', '.copy-citation-btn', function () {
                var text = $(this).data('citation') || '';
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text);
                } else {
                    var ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    try { document.execCommand('copy'); } catch (e) { }
                    document.body.removeChild(ta);
                }
                $(this).text('Đã chép');
                var btn = $(this);
                setTimeout(function () { btn.text('Chép trích dẫn'); }, 1500);
            });


            // AI analysis handler (delegated)
            // analyze button - open modal and load analysis
            $('body').on('click', '.analyze-btn', function () {
                var id = $(this).data('id');
                $('#analysisModalBody').html('<div class="text-center p-4"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div><div class="mt-2">Đang phân tích...</div></div>');
                $('#analysisModal').modal('show');

                $.post('@Url.Action("Analyze", "Evidence")', { id: id })
                    .done(function (html) {
                        // The controller returns a partial HTML view
                        $('#analysisModalBody').html(html);
                    })
                    .fail(function () {
                        $('#analysisModalBody').html('<div class="text-danger">Không thể phân tích. Vui lòng thử lại sau.</div>');
                    });
            });

            // copy analysis / citation from modal
            $('body').on('click', '.copy-analysis-btn', function () {
                var text = $(this).data('text') || '';
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text);
                } else {
                    var ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    try { document.execCommand('copy'); } catch (e) { }
                    document.body.removeChild(ta);
                }
                $(this).text('Đã chép');
                var btn = $(this);
                setTimeout(function () { btn.text('Chép trích dẫn'); }, 1500);
            });


            // initialize - highlight "Tất cả" button
            $('#categoryButtons .category-btn').first().addClass('active btn-primary').removeClass('btn-outline-secondary');

            // Load suggestions on initial page load (only if server didn't render)
            if ($('#userInterestsContainer').length) {
                loadSuggestions();
            }

        })();
    </script>
}

@section styles {
    <style>

        #paginationContainer .pagination {
            justify-content: center !important;
        }

        #analysisModal .modal-header {
            position: relative;
            padding-right: 3rem; /* make room for absolute close */
            align-items: center;
        }

            #analysisModal .modal-header .modal-title {
                margin: 0;
            }

            #analysisModal .modal-header .close, .close {
                position: absolute;
                right: 1rem;
                top: 0.75rem;
                border: none;
                background: transparent;
                font-size: 1.25rem;
                line-height: 1;
                padding: 0.25rem;
                color: inherit;
            }

                #analysisModal .modal-header .close:focus, .close:focus {
                    outline: solid;
                    box-shadow: none;
                }
    </style>
}