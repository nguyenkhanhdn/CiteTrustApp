@model IEnumerable<CiteTrustApp.Models.Evidence>
@{
    ViewBag.Title = "Tìm kiếm dẫn chứng";
    var categories = ViewBag.Categories as List<CiteTrustApp.Models.Category> ?? new List<CiteTrustApp.Models.Category>();
    var sources = ViewBag.Sources as List<CiteTrustApp.Models.Source> ?? new List<CiteTrustApp.Models.Source>();
    Layout = "~/Views/Shared/_LayoutNoHero.cshtml";
}

<section id="breadcrumbs" class="breadcrumbs">
    <div class="breadcrumb-hero">
        <div class="container">
            <div class="breadcrumb-hero">
                <h2>Ngân hàng dẫn chứng học thuật</h2>
            </div>
        </div>
    </div>

</section><!-- End Breadcrumbs -->
<div class="container my-4">
    <div class="card p-4 mb-4">
        <div class="row">
            <div class="col-md-8 mb-2">
                <input id="qInput" class="form-control" placeholder="Tìm kiếm dẫn chứng, tác giả..." />
            </div>
            <div class="col-md-4 mb-2">
                <select id="sourceSelect" class="form-control">
                    <option value="">Tất cả nguồn</option>
                    @foreach (var s in sources)
                    {
                        <option value="@s.Id">@s.Title</option>
                    }
                </select>
            </div>
        </div>

        <div class="mt-3">
            <div id="categoryButtons" class="d-flex flex-wrap">
                <button class="btn btn-sm btn-primary mr-2 mb-2 category-btn" data-category="">Tất cả</button>
                @foreach (var c in categories)
                {
                    <button class="btn btn-sm btn-outline-secondary mr-2 mb-2 category-btn" data-category="@c.Id">@c.Name</button>
                }
            </div>
        </div>
    </div>

    <div id="results" class="row">
        @foreach (var ev in Model)
        {
            @Html.Partial("_EvidenceCard", ev)
        }
    </div>

    <div id="noResults" class="alert alert-light" style="display:none;">
        Không tìm thấy kết quả.
    </div>
</div>


<!-- Modal for AI analysis -->
<div class="modal fade" id="analysisModal" tabindex="-1" role="dialog" aria-labelledby="analysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="analysisModalLabel" class="modal-title">Phân tích</h5>.
                <button type="button" id="btnClose" onclick="doClose()" class="close" data-bs-dismiss="modal" aria-label="Đóng">
                    <span aria-hidden="true">X</span>
                </button>
                
            </div>
            <div id="analysisModalBody" class="modal-body">
                <div class="text-center p-4">
                    <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
                    <div class="mt-2">Đang phân tích...</div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>

        function doClose() {            
            var modal = $('#aiAnalysisModal');
            if (modal.length) {
                modal.modal('hide');
            }
        }
        (function () {
            var searchTimeout;
            function performSearch() {
                var q = $('#qInput').val();
                var categoryId = $('.category-btn.active').data('category');
                var sourceId = $('#sourceSelect').val();

                $.get('@Url.Action("SearchAjax", "Evidence")', { q: q, categoryId: categoryId, sourceId: sourceId })
                    .done(function (res) {
                        $('#results').html(res.html);
                        if (!res.html || res.html.trim() === '') {
                            $('#noResults').show();
                        } else {
                            $('#noResults').hide();
                        }
                    });
            }

            // debounce input
            $('#qInput').on('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 350);
            });

            // source change
            $('#sourceSelect').on('change', performSearch);

            // category buttons
            $('#categoryButtons').on('click', '.category-btn', function () {
                $('.category-btn').removeClass('active btn-primary').addClass('btn-outline-secondary');
                $(this).removeClass('btn-outline-secondary').addClass('active btn-primary');
                performSearch();
            });

            // copy handler (delegated)
            $('body').on('click', '.copy-citation-btn', function () {
                var text = $(this).data('citation') || '';
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text);
                } else {
                    var ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    try { document.execCommand('copy'); } catch (e) { }
                    document.body.removeChild(ta);
                }
                $(this).text('Đã chép');
                var btn = $(this);
                setTimeout(function () { btn.text('Chép trích dẫn'); }, 1500);
            });


            // AI analysis handler (delegated)
            // analyze button - open modal and load analysis
            $('body').on('click', '.analyze-btn', function () {
                var id = $(this).data('id');
                $('#analysisModalBody').html('<div class="text-center p-4"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div><div class="mt-2">Đang phân tích...</div></div>');
                $('#analysisModal').modal('show');

                $.post('@Url.Action("Analyze", "Evidence")', { id: id })
                    .done(function (html) {
                        // The controller returns a partial HTML view
                        $('#analysisModalBody').html(html);
                    })
                    .fail(function () {
                        $('#analysisModalBody').html('<div class="text-danger">Không thể phân tích. Vui lòng thử lại sau.</div>');
                    });
            });

            // copy analysis / citation from modal
            $('body').on('click', '.copy-analysis-btn', function () {
                var text = $(this).data('text') || '';
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text);
                } else {
                    var ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    try { document.execCommand('copy'); } catch (e) { }
                    document.body.removeChild(ta);
                }
                $(this).text('Đã chép');
                var btn = $(this);
                setTimeout(function () { btn.text('Chép trích dẫn'); }, 1500);
            });

            
            // initialize - highlight "Tất cả" button
            $('#categoryButtons .category-btn').first().addClass('active btn-primary').removeClass('btn-outline-secondary');
            

        })();
    </script>
}

@section styles {
    <style>
        #analysisModal .modal-header {
            position: relative;
            padding-right: 3rem; /* make room for absolute close */
            align-items: center;
        }

            #analysisModal .modal-header .modal-title {
                margin: 0;
            }

            #analysisModal .modal-header .close,.close{
                position: absolute;
                right: 1rem;
                top: 0.75rem;
                border: none;
                background: transparent;
                font-size: 1.25rem;
                line-height: 1;
                padding: 0.25rem;
                color: inherit;
            }

                #analysisModal .modal-header .close:focus, .close:focus {
                    outline: solid;
                    box-shadow: none;
                }
    </style>
}